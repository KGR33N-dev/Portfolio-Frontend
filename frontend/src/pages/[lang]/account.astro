---
import Layout from '~/layouts/PageLayout.astro';
import Headline from '~/components/ui/Headline.astro';
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import { useTranslations } from '~/i18n/utils';
import { languages } from '~/i18n';

export function getStaticPaths() {
  return Object.keys(languages).map(lang => ({
    params: { lang }
  }));
}

const { lang } = Astro.params;
const t = useTranslations(lang as keyof typeof languages);

const metadata = {
  title: t('account.title'),
  description: t('account.subtitle'),
  robots: {
    index: false,
    follow: false,
  },
};
---

<Layout metadata={metadata}>
  <WidgetWrapper id="account-page" containerClass="max-w-4xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
    <!-- Header with navigation -->
    <div class="bg-white dark:bg-slate-900 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700 mb-8">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
        <Headline 
          title={t('account.title')}
          subtitle={t('account.subtitle')}
          classes={{
            container: '',
            title: 'text-2xl font-bold text-gray-900 dark:text-white',
            subtitle: 'text-sm text-gray-600 dark:text-gray-400 mt-1'
          }}
        />
        <a 
          href={`/${lang}/admin/dashboard`}
          class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors duration-200 font-medium"
        >
          ← Dashboard
        </a>
      </div>
    </div>

    <!-- Messages -->
    <div id="error-message" class="hidden bg-red-100 dark:bg-red-900/20 border border-red-400 text-red-700 dark:text-red-400 px-4 py-3 rounded mb-6"></div>
    <div id="success-message" class="hidden bg-green-100 dark:bg-green-900/20 border border-green-400 text-green-700 dark:text-green-400 px-4 py-3 rounded mb-6"></div>

    <!-- Main Content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    
      <!-- User Info Card -->
      <div class="lg:col-span-1">
        <div class="bg-white dark:bg-slate-900 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700 p-6">
          <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-6">{t('account.personalInfo')}</h3>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{t('auth.email')}</label>
              <div id="user-email" class="py-2 px-3 rounded-md bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200">admin@example.com</div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{t('auth.username')}</label>
              <div id="user-username" class="py-2 px-3 rounded-md bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200">admin</div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{t('auth.fullName')}</label>
              <div id="user-fullname" class="py-2 px-3 rounded-md bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200">Administrator</div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{t('account.role')}</label>
              <div id="user-role" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/20 dark:text-purple-300">Administrator</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Account Management Forms -->
      <div class="lg:col-span-2 space-y-6">
        
        <!-- Change Username Form -->
        <div class="bg-white dark:bg-slate-900 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700">
          <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white">{t('account.changeUsername')}</h3>
          </div>
          <div class="p-6">
            <form id="username-form">
              <div class="space-y-4">
                <div>
                  <label for="new-username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{t('auth.username')}</label>
                  <input 
                    type="text" 
                    id="new-username" 
                    name="username"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                    placeholder={t('account.newUsernamePlaceholder')}
                    value="admin"
                    pattern="[a-zA-Z0-9_-]+"
                    minlength="3"
                    maxlength="50"
                    required
                  />
                  <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">3-50 znaków: litery, cyfry, _ i -</p>
                </div>
                <div>
                  <label for="username-current-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Obecne hasło</label>
                  <input 
                    type="password" 
                    id="username-current-password" 
                    name="current_password"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                    placeholder="Wpisz obecne hasło"
                    required
                  />
                </div>
              </div>
              <div class="mt-6">
                <button 
                  type="submit" 
                  class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors duration-200"
                >
                  {t('account.updateUsername')}
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Change Password Form -->
        <div class="bg-white dark:bg-slate-900 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700">
          <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white">{t('account.changePassword')}</h3>
          </div>
          <div class="p-6">
            <form id="password-form">
              <div class="space-y-4">
                <div>
                  <label for="current-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{t('account.currentPassword')}</label>
                  <input 
                    type="password" 
                    id="current-password" 
                    name="currentPassword"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                    placeholder={t('account.currentPasswordPlaceholder')}
                    required
                  />
                </div>
                <div>
                  <label for="new-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{t('account.newPassword')}</label>
                  <input 
                    type="password" 
                    id="new-password" 
                    name="newPassword"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                    placeholder={t('account.newPasswordPlaceholder')}
                    minlength="8"
                    required
                  />
                  <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Minimum 8 znaków</p>
                </div>
                <div>
                  <label for="confirm-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{t('account.confirmNewPassword')}</label>
                  <input 
                    type="password" 
                    id="confirm-password" 
                    name="confirmPassword"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                    placeholder={t('account.confirmPasswordPlaceholder')}
                    required
                  />
                </div>
              </div>
              <div class="mt-6">
                <button 
                  type="submit" 
                  class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors duration-200"
                >
                  {t('account.updatePassword')}
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Change Email Form -->
        <div class="bg-white dark:bg-slate-900 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700">
          <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Zmień adres email</h3>
          </div>
          <div class="p-6">
            <form id="email-form">
              <div class="space-y-4">
                <div>
                  <label for="new-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nowy adres email</label>
                  <input 
                    type="email" 
                    id="new-email" 
                    name="email"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                    placeholder="nowy@email.com"
                    required
                  />
                </div>
                <div>
                  <label for="email-current-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Obecne hasło</label>
                  <input 
                    type="password" 
                    id="email-current-password" 
                    name="current_password"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                    placeholder="Wpisz obecne hasło"
                    required
                  />
                </div>
              </div>
              <div class="mt-6">
                <button 
                  type="submit" 
                  class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors duration-200"
                >
                  Zaktualizuj email
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Delete Account Form -->
        <div class="bg-white dark:bg-slate-900 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700">
          <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-medium text-red-600 dark:text-red-400">{t('account.deleteAccount')}</h3>
          </div>
          <div class="p-6">
            <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-md p-4 mb-4">
              <p class="text-sm text-red-800 dark:text-red-300">
                {t('account.confirmDelete')}
              </p>
            </div>
            <form id="delete-form">
              <div class="space-y-4">
                <div>
                  <label for="delete-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{t('auth.password')}</label>
                  <input 
                    type="password" 
                    id="delete-password" 
                    name="password"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 dark:bg-gray-700 dark:text-white"
                    placeholder={t('account.currentPasswordPlaceholder')}
                    required
                  />
                </div>
                <div>
                  <label for="delete-confirmation" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Wpisz "DELETE_MY_ACCOUNT" aby potwierdzić</label>
                  <input 
                    type="text" 
                    id="delete-confirmation" 
                    name="confirmation"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 dark:bg-gray-700 dark:text-white"
                    placeholder="DELETE_MY_ACCOUNT"
                    required
                  />
                </div>
              </div>
              <div class="mt-6">
                <button 
                  type="submit" 
                  class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors duration-200"
                  disabled
                  id="delete-submit"
                >
                  {t('account.deleteAccount')}
                </button>
              </div>
            </form>
          </div>
        </div>
        
      </div>
    </div>
  </WidgetWrapper>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Account page loaded successfully');
    
    // API Configuration
    const API_BASE = 'http://localhost:8000/api';
    
    // Get auth token from localStorage
    function getToken() {
      return localStorage.getItem('authToken');
    }
    
    // API Headers
    function getHeaders() {
      return {
        'Authorization': `Bearer ${getToken()}`,
        'Content-Type': 'application/json'
      };
    }
    
    // Profile Service
    const ProfileService = {
      async getProfile() {
        try {
          const response = await fetch(`${API_BASE}/profile/`, {
            headers: getHeaders()
          });
          const data = await response.json();
          if (response.ok) {
            return { success: true, data };
          } else {
            return { success: false, error: data.detail || 'Błąd pobierania profilu' };
          }
        } catch (error) {
          return { success: false, error: 'Błąd połączenia z serwerem' };
        }
      },

      async changePassword(currentPassword, newPassword, confirmPassword) {
        try {
          const response = await fetch(`${API_BASE}/profile/change-password`, {
            method: 'PUT',
            headers: getHeaders(),
            body: JSON.stringify({
              current_password: currentPassword,
              new_password: newPassword,
              confirm_password: confirmPassword
            })
          });
          const data = await response.json();
          return { success: response.ok, data, error: data.detail };
        } catch (error) {
          return { success: false, error: 'Błąd połączenia z serwerem' };
        }
      },

      async changeUsername(newUsername, currentPassword) {
        try {
          const response = await fetch(`${API_BASE}/profile/change-username`, {
            method: 'PUT',
            headers: getHeaders(),
            body: JSON.stringify({
              new_username: newUsername,
              current_password: currentPassword
            })
          });
          const data = await response.json();
          return { success: response.ok, data, error: data.detail };
        } catch (error) {
          return { success: false, error: 'Błąd połączenia z serwerem' };
        }
      },

      async changeEmail(newEmail, currentPassword) {
        try {
          const response = await fetch(`${API_BASE}/profile/change-email`, {
            method: 'PUT',
            headers: getHeaders(),
            body: JSON.stringify({
              new_email: newEmail,
              current_password: currentPassword
            })
          });
          const data = await response.json();
          return { success: response.ok, data, error: data.detail };
        } catch (error) {
          return { success: false, error: 'Błąd połączenia z serwerem' };
        }
      },

      async deleteAccount(currentPassword) {
        try {
          const response = await fetch(`${API_BASE}/profile/delete-account`, {
            method: 'DELETE',
            headers: getHeaders(),
            body: JSON.stringify({
              current_password: currentPassword,
              confirmation: "DELETE_MY_ACCOUNT"
            })
          });
          const data = await response.json();
          return { success: response.ok, data, error: data.detail };
        } catch (error) {
          return { success: false, error: 'Błąd połączenia z serwerem' };
        }
      }
    };
    
    // DOM Elements
    const usernameForm = document.getElementById('username-form');
    const passwordForm = document.getElementById('password-form');
    const emailForm = document.getElementById('email-form');
    const deleteForm = document.getElementById('delete-form');
    const deleteConfirmationInput = document.getElementById('delete-confirmation');
    const deleteSubmitBtn = document.getElementById('delete-submit');
    
    // Load profile data on page load
    loadProfileData();
    
    async function loadProfileData() {
      const result = await ProfileService.getProfile();
      if (result.success) {
        updateProfileDisplay(result.data);
      } else {
        showMessage(result.error, 'error');
      }
    }
    
    function updateProfileDisplay(profile) {
      const elements = {
        'user-email': profile.email,
        'user-username': profile.username,
        'user-fullname': profile.full_name || 'Nie podano',
        'user-role': profile.role?.display_name || profile.role?.name || 'User'
      };
      
      Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = value;
        }
      });
      
      // Update form fields
      const newUsernameInput = document.getElementById('new-username');
      const newEmailInput = document.getElementById('new-email');
      if (newUsernameInput) newUsernameInput.value = profile.username;
      if (newEmailInput) newEmailInput.value = profile.email;
    }
    
    // Username form handler
    if (usernameForm) {
      usernameForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const newUsername = formData.get('username');
        const currentPassword = formData.get('current_password');
        
        if (!newUsername || !currentPassword) {
          showMessage('Wypełnij wszystkie pola', 'error');
          return;
        }
        
        setButtonLoading(this.querySelector('button[type="submit"]'), true);
        
        const result = await ProfileService.changeUsername(newUsername, currentPassword);
        
        if (result.success) {
          showMessage(result.data.message, 'success');
          loadProfileData(); // Refresh profile data
          this.querySelector('input[name="current_password"]').value = '';
        } else {
          showMessage(result.error, 'error');
        }
        
        setButtonLoading(this.querySelector('button[type="submit"]'), false);
      });
    }
    
    // Password form handler
    if (passwordForm) {
      passwordForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const currentPassword = formData.get('currentPassword');
        const newPassword = formData.get('newPassword');
        const confirmPassword = formData.get('confirmPassword');
        
        if (!currentPassword || !newPassword || !confirmPassword) {
          showMessage('Wypełnij wszystkie pola', 'error');
          return;
        }
        
        if (newPassword !== confirmPassword) {
          showMessage('Nowe hasła nie są identyczne', 'error');
          return;
        }
        
        if (newPassword.length < 8) {
          showMessage('Nowe hasło musi mieć minimum 8 znaków', 'error');
          return;
        }
        
        setButtonLoading(this.querySelector('button[type="submit"]'), true);
        
        const result = await ProfileService.changePassword(currentPassword, newPassword, confirmPassword);
        
        if (result.success) {
          showMessage(result.data.message, 'success');
          this.reset(); // Clear form
        } else {
          showMessage(result.error, 'error');
        }
        
        setButtonLoading(this.querySelector('button[type="submit"]'), false);
      });
    }
    
    // Email form handler
    if (emailForm) {
      emailForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const newEmail = formData.get('email');
        const currentPassword = formData.get('current_password');
        
        if (!newEmail || !currentPassword) {
          showMessage('Wypełnij wszystkie pola', 'error');
          return;
        }
        
        if (!isValidEmail(newEmail)) {
          showMessage('Nieprawidłowy format email', 'error');
          return;
        }
        
        setButtonLoading(this.querySelector('button[type="submit"]'), true);
        
        const result = await ProfileService.changeEmail(newEmail, currentPassword);
        
        if (result.success) {
          showMessage(result.data.message, 'success');
          if (result.data.requires_verification) {
            showMessage('Email wymaga ponownej weryfikacji. Sprawdź swoją skrzynkę pocztową.', 'info');
          }
          loadProfileData(); // Refresh profile data
          this.querySelector('input[name="current_password"]').value = '';
        } else {
          showMessage(result.error, 'error');
        }
        
        setButtonLoading(this.querySelector('button[type="submit"]'), false);
      });
    }
    
    // Delete form handler
    if (deleteForm) {
      deleteForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!confirm('⚠️ OSTRZEŻENIE: Ta operacja jest NIEODWRACALNA!\n\nCzy na pewno chcesz usunąć swoje konto?\nWszystkie Twoje dane zostaną permanentnie utracone.')) {
          return;
        }
        
        const formData = new FormData(this);
        const password = formData.get('password');
        const confirmation = formData.get('confirmation');
        
        if (!password) {
          showMessage('Wpisz hasło do potwierdzenia', 'error');
          return;
        }
        
        if (confirmation.trim().toUpperCase() !== 'DELETE_MY_ACCOUNT') {
          showMessage('Wpisz dokładnie: DELETE_MY_ACCOUNT', 'error');
          return;
        }
        
        setButtonLoading(this.querySelector('button[type="submit"]'), true);
        
        const result = await ProfileService.deleteAccount(password);
        
        if (result.success) {
          showMessage(result.data.message, 'success');
          // Redirect to logout after successful deletion
          setTimeout(() => {
            localStorage.removeItem('authToken');
            window.location.href = '/login';
          }, 3000);
        } else {
          showMessage(result.error, 'error');
        }
        
        setButtonLoading(this.querySelector('button[type="submit"]'), false);
      });
    }
    
    // Enable delete button when confirmation is typed
    if (deleteConfirmationInput && deleteSubmitBtn) {
      deleteConfirmationInput.addEventListener('input', function() {
        const isValid = this.value.trim().toUpperCase() === 'DELETE_MY_ACCOUNT';
        deleteSubmitBtn.disabled = !isValid;
        deleteSubmitBtn.className = isValid 
          ? 'px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors duration-200'
          : 'px-4 py-2 bg-gray-400 text-gray-700 rounded-lg font-medium cursor-not-allowed opacity-50';
      });
    }
    
    // Utility functions
    function setButtonLoading(button, loading) {
      if (!button) return;
      
      if (loading) {
        button.disabled = true;
        button.dataset.originalText = button.textContent;
        button.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mx-auto"></div>';
      } else {
        button.disabled = false;
        button.textContent = button.dataset.originalText || button.textContent;
      }
    }
    
    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }
    
    // Message display function
    function showMessage(message, type) {
      const errorDiv = document.getElementById('error-message');
      const successDiv = document.getElementById('success-message');
      
      if (!errorDiv || !successDiv) return;
      
      // Hide both messages first
      errorDiv.classList.add('hidden');
      successDiv.classList.add('hidden');
      
      // Show appropriate message
      if (type === 'error') {
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
      } else {
        successDiv.textContent = message;
        successDiv.classList.remove('hidden');
      }
      
      // Auto-hide after 8 seconds
      setTimeout(() => {
        errorDiv.classList.add('hidden');
        successDiv.classList.add('hidden');
      }, 8000);
    }
  });
</script>

<style>
  /* Form field focus animations */
  input:focus {
    animation: focusGlow 0.3s ease-in-out;
  }

  @keyframes focusGlow {
    0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }
    100% { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
  }

  /* Button loading state */
  button:disabled {
    cursor: not-allowed;
    opacity: 0.7;
  }

  /* Smooth transitions */
  .transition-all {
    transition: all 0.2s ease-in-out;
  }
</style>
